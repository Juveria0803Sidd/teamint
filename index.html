<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login with Azure AD and View Teams</title>
    <!-- Include MSAL.js for authentication -->
    <script src="https://alcdn.msauth.net/browser/2.17.0/js/msal-browser.min.js"></script>
    <!-- Include MGT styles and scripts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/microsoft-graph-toolkit/0.31.0/mgt.css">
    <script type="module" src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-graph-toolkit/0.31.0/mgt.min.js"></script>
    <script type="module" src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-graph-toolkit/0.31.0/mgt-msal2-provider.min.js"></script>
    <script type="module" src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-graph-toolkit/0.31.0/mgt-agenda.min.js"></script>
    <style>
        /* ... existing styles ... */
    </style>
</head>
<body>
    <div class="container">
        <h2>Login with Azure AD</h2>
        <button id="login">Login</button>
        <button id="showTeams" style="display:none;">Show Teams</button>
        <div id="teamsDisplay" style="display:none;">
            <h3>Your Teams:</h3>
            <ul id="teamsList"></ul>
        </div>
        <div id="messages" style="display:none;">
            <h3>Messages in Channel:</h3>
            <ul id="messagesList"></ul>
            <textarea id="messageInput" placeholder="Type your message here..." rows="4" style="width: 100%; margin-top: 10px;"></textarea>
            <button id="sendMessage">Send Message</button>
        </div>
        <!-- Add the Agenda component -->
        <div id="agendaContainer" style="margin-top: 20px;">
            <mgt-agenda view="month"></mgt-agenda>
        </div>
    </div>

    <script>
        const msalConfig = {
            auth: {
                clientId: '9eac5713-ea50-4c18-bac7-5839a30f0101',
                authority: 'https://login.microsoftonline.com/04a705d7-fbf2-41bc-bb46-19685d7a1db8',
                redirectUri: 'https://sdes11.github.io/teamint/'
            }
        };

        const msalInstance = new msal.PublicClientApplication(msalConfig);
        const loginRequest = {
            scopes: ["User.Read", "ChannelMessage.Read.All", "ChannelMessage.Send", "Team.ReadBasic.All", "Calendars.Read"] // Add Calendars.Read scope
        };

        let selectedTeamId = null;
        let selectedChannelId = null;

        Providers.globalProvider = new Msal2Provider(msalConfig.auth);

        document.getElementById('login').addEventListener('click', async function() {
            try {
                console.log("Starting login process...");
                const loginResponse = await msalInstance.loginPopup(loginRequest);
                console.log('Logged in successfully:', loginResponse);
                msalInstance.setActiveAccount(loginResponse.account);
                alert('Login successful!');
                document.getElementById('showTeams').style.display = 'block';
                // Fetch user's events after a successful login
                await fetchEvents();
            } catch (error) {
                console.error('Login failed:', error);
                alert('Login failed. Please check the console for more details.');
            }
        });

        // ... existing team and message functionality ...

        async function fetchEvents() {
            const account = msalInstance.getActiveAccount();
            if (!account) {
                alert('No active account found. Please log in.');
                return;
            }

            try {
                console.log("Attempting to acquire token silently for events...");
                const tokenResponse = await msalInstance.acquireTokenSilent({ ...loginRequest, account });
                console.log("Token acquired successfully for events:", tokenResponse);

                const response = await fetch('https://graph.microsoft.com/v1.0/me/events', {
                    headers: {
                        'Authorization': 'Bearer ' + tokenResponse.accessToken
                    }
                });

                if (!response.ok) {
                    throw new Error(`Error fetching events: ${response.statusText}`);
                }

                const data = await response.json();
                console.log("Events data fetched:", data);
                displayEvents(data.value);
            } catch (error) {
                console.error('Error fetching events:', error);
                alert('Error fetching events. Please check the console for more details.');
            }
        }

        function displayEvents(events) {
            console.log("Displaying events...");
            const agenda = document.querySelector('mgt-agenda');
            if (events.length > 0) {
                agenda.items = events.map(event => ({
                    title: event.subject,
                    start: new Date(event.start.dateTime),
                    end: new Date(event.end.dateTime),
                    location: event.location.displayName || '',
                    description: event.body.content || ''
                }));
            } else {
                console.warn("No events found or insufficient permissions.");
                agenda.items = [];
            }
        }

        registerMgtLoginComponent();
        registerMgtAgendaComponent();
    </script>
</body>
</html>
